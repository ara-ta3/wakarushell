#!/bin/sh

# シェル変数を展開した時値が設定されていないとエラー
set -u

usage() {
    echo "Usage: `basename $0` [-h] [channel_with_#]"
    echo "Default channel is #_vg14engineer"
    exit
}

while getopts :h OPTION
do
    case $OPTION in
        h)
            usage
        ;;
    esac
done

channel=${1:-"#_vg14engineer"}
dir=`dirname $0`
token=`cat ${dir}/../token`
jq=`which jq`
size=`cat ${dir}/../usernames.json|jq ".users|length"`
target=$(($RANDOM % ${size}))
username=`cat ${dir}/../usernames.json|jq ".users[${target}].user"|sed -e 's/\"//g'`
icon=`cat ${dir}/../usernames.json|jq ".users[${target}].icon"|sed -e 's/\"//g'`
curl -F token=${token} -F channel=${channel} -F text="わかる" -F username=${username} -F icon_url=${icon} https://slack.com/api/chat.postMessage
